{"version":3,"sources":["../../src/datasource/sanitize-html.js"],"names":["each","obj","cb","Object","keys","forEach","key","has","hasOwnProperty","call","sanitizeHtml","html","options","_recursing","result","Frame","tag","attribs","that","tagPosition","length","text","updateParentNodeText","stack","parentFrame","defaults","parser","htmlParserDefaults","extend","nonTextTagsArray","nonTextTags","allowedAttributesMap","allowedAttributesGlobMap","allowedAttributes","attributes","globRegex","name","indexOf","push","quoteRegexp","replace","RegExp","join","allowedClassesMap","allowedClasses","classes","transformTagsMap","transformTagsAll","transformTags","transform","transFun","simpleTransform","depth","skipMap","transformMap","skipText","skipTextDepth","htmlparser","Parser","onopentag","frame","skip","hasText","transformedTag","undefined","innerText","tagName","allowedTags","value","a","test","naughtyHref","filterClasses","escapeHtml","selfClosing","textFilter","ontext","lastFrame","escaped","onclosetag","pop","exclusiveFilter","substr","write","end","s","href","matches","match","allowProtocolRelative","scheme","toLowerCase","allowedSchemesByTag","allowedSchemes","allowed","split","filter","clss","require","module","exports","decodeEntities","img","newTagName","newAttribs","merge","attrib"],"mappings":"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","file":"sanitize-html.js","sourcesContent":["var htmlparser = require('htmlparser2');\nvar extend = require('xtend');\nvar quoteRegexp = require('regexp-quote');\n\nfunction each(obj, cb) {\n  if (obj) Object.keys(obj).forEach(function (key) {\n    cb(obj[key], key);\n  });\n}\n\n// Avoid false positives with .__proto__, .hasOwnProperty, etc.\nfunction has(obj, key) {\n  return ({}).hasOwnProperty.call(obj, key);\n}\n\nmodule.exports = sanitizeHtml;\n\n// Ignore the _recursing flag; it's there for recursive\n// invocation as a guard against this exploit:\n// https://github.com/fb55/htmlparser2/issues/105\n\nfunction sanitizeHtml(html, options, _recursing) {\n  var result = '';\n\n  function Frame(tag, attribs) {\n    var that = this;\n    this.tag = tag;\n    this.attribs = attribs || {};\n    this.tagPosition = result.length;\n    this.text = ''; // Node inner text\n\n    this.updateParentNodeText = function() {\n      if (stack.length) {\n          var parentFrame = stack[stack.length - 1];\n          parentFrame.text += that.text;\n      }\n    };\n  }\n\n  if (!options) {\n    options = sanitizeHtml.defaults;\n    options.parser = htmlParserDefaults;\n  } else {\n    options = extend(sanitizeHtml.defaults, options);\n    if (options.parser) {\n      options.parser = extend(htmlParserDefaults, options.parser);\n    } else {\n      options.parser = htmlParserDefaults;\n    }\n  }\n\n  // Tags that contain something other than HTML, or where discarding\n  // the text when the tag is disallowed makes sense for other reasons.\n  // If we are not allowing these tags, we should drop their content too.\n  // For other tags you would drop the tag but keep its content.\n  var nonTextTagsArray = options.nonTextTags || [ 'script', 'style', 'textarea' ];\n  var allowedAttributesMap;\n  var allowedAttributesGlobMap;\n  if(options.allowedAttributes) {\n    allowedAttributesMap = {};\n    allowedAttributesGlobMap = {};\n    each(options.allowedAttributes, function(attributes, tag) {\n      allowedAttributesMap[tag] = [];\n      var globRegex = [];\n      attributes.forEach(function(name) {\n        if(name.indexOf('*') >= 0) {\n          globRegex.push(quoteRegexp(name).replace(/\\\\\\*/g, '.*'));\n        } else {\n          allowedAttributesMap[tag].push(name);\n        }\n      });\n      allowedAttributesGlobMap[tag] = new RegExp('^(' + globRegex.join('|') + ')$');\n    });\n  }\n  var allowedClassesMap = {};\n  each(options.allowedClasses, function(classes, tag) {\n    // Implicitly allows the class attribute\n    if(allowedAttributesMap) {\n      if (!has(allowedAttributesMap, tag)) {\n        allowedAttributesMap[tag] = [];\n      }\n      allowedAttributesMap[tag].push('class');\n    }\n\n    allowedClassesMap[tag] = classes;\n  });\n\n  var transformTagsMap = {};\n  var transformTagsAll;\n  each(options.transformTags, function(transform, tag) {\n    var transFun;\n    if (typeof transform === 'function') {\n      transFun = transform;\n    } else if (typeof transform === \"string\") {\n      transFun = sanitizeHtml.simpleTransform(transform);\n    }\n    if (tag === '*') {\n      transformTagsAll = transFun;\n    } else {\n      transformTagsMap[tag] = transFun;\n    }\n  });\n\n  var depth = 0;\n  var stack = [];\n  var skipMap = {};\n  var transformMap = {};\n  var skipText = false;\n  var skipTextDepth = 0;\n\n  var parser = new htmlparser.Parser({\n    onopentag: function(name, attribs) {\n      if (skipText) {\n        skipTextDepth++;\n        return;\n      }\n      var frame = new Frame(name, attribs);\n      stack.push(frame);\n\n      var skip = false;\n      var hasText = frame.text ? true : false;\n      var transformedTag;\n      if (has(transformTagsMap, name)) {\n        transformedTag = transformTagsMap[name](name, attribs);\n\n        frame.attribs = attribs = transformedTag.attribs;\n\n        if (transformedTag.text !== undefined) {\n          frame.innerText = transformedTag.text;\n        }\n\n        if (name !== transformedTag.tagName) {\n          frame.name = name = transformedTag.tagName;\n          transformMap[depth] = transformedTag.tagName;\n        }\n      }\n      if (transformTagsAll) {\n        transformedTag = transformTagsAll(name, attribs);\n\n        frame.attribs = attribs = transformedTag.attribs;\n        if (name !== transformedTag.tagName) {\n          frame.name = name = transformedTag.tagName;\n          transformMap[depth] = transformedTag.tagName;\n        }\n      }\n\n      if (options.allowedTags && options.allowedTags.indexOf(name) === -1) {\n        skip = true;\n        if (nonTextTagsArray.indexOf(name) !== -1) {\n          skipText = true;\n          skipTextDepth = 1;\n        }\n        skipMap[depth] = true;\n      }\n      depth++;\n      if (skip) {\n        // We want the contents but not this tag\n        return;\n      }\n      result += '<' + name;\n      if (!allowedAttributesMap || has(allowedAttributesMap, name) || allowedAttributesMap['*']) {\n        each(attribs, function(value, a) {\n          if (!allowedAttributesMap ||\n              (has(allowedAttributesMap, name) && allowedAttributesMap[name].indexOf(a) !== -1 ) ||\n              (allowedAttributesMap['*'] && allowedAttributesMap['*'].indexOf(a) !== -1 ) ||\n              (has(allowedAttributesGlobMap, name) && allowedAttributesGlobMap[name].test(a)) ||\n              (allowedAttributesGlobMap['*'] && allowedAttributesGlobMap['*'].test(a))) {\n            if ((a === 'href') || (a === 'src')) {\n              if (naughtyHref(name, value)) {\n                delete frame.attribs[a];\n                return;\n              }\n            }\n            if (a === 'class') {\n              value = filterClasses(value, allowedClassesMap[name]);\n              if (!value.length) {\n                delete frame.attribs[a];\n                return;\n              }\n            }\n            result += ' ' + a;\n            if (value.length) {\n              result += '=\"' + escapeHtml(value) + '\"';\n            }\n          } else {\n            delete frame.attribs[a];\n          }\n        });\n      }\n      if (options.selfClosing.indexOf(name) !== -1) {\n        result += \" />\";\n      } else {\n        result += \">\";\n        if (frame.innerText && !hasText && !options.textFilter) {\n          result += frame.innerText;\n        }\n      }\n    },\n    ontext: function(text) {\n      if (skipText) {\n        return;\n      }\n      var lastFrame = stack[stack.length-1];\n      var tag;\n\n      if (lastFrame) {\n        tag = lastFrame.tag;\n        // If inner text was set by transform function then let's use it\n        text = lastFrame.innerText !== undefined ? lastFrame.innerText : text;\n      }\n\n      if ((tag === 'script') || (tag === 'style')) {\n        // htmlparser2 gives us these as-is. Escaping them ruins the content. Allowing\n        // script tags is, by definition, game over for XSS protection, so if that's\n        // your concern, don't allow them. The same is essentially true for style tags\n        // which have their own collection of XSS vectors.\n        result += text;\n      } else {\n        var escaped = escapeHtml(text);\n        if (options.textFilter) {\n          result += options.textFilter(escaped);\n        } else {\n          result += escaped;\n        }\n      }\n      if (stack.length) {\n           var frame = stack[stack.length - 1];\n           frame.text += text;\n      }\n    },\n    onclosetag: function(name) {\n\n      if (skipText) {\n        skipTextDepth--;\n        if (!skipTextDepth) {\n          skipText = false;\n        } else {\n          return;\n        }\n      }\n\n      var frame = stack.pop();\n      if (!frame) {\n        // Do not crash on bad markup\n        return;\n      }\n      skipText = false;\n      depth--;\n      if (skipMap[depth]) {\n        delete skipMap[depth];\n        frame.updateParentNodeText();\n        return;\n      }\n\n      if (transformMap[depth]) {\n        name = transformMap[depth];\n        delete transformMap[depth];\n      }\n\n      if (options.exclusiveFilter && options.exclusiveFilter(frame)) {\n         result = result.substr(0, frame.tagPosition);\n         return;\n      }\n\n      frame.updateParentNodeText();\n\n      if (options.selfClosing.indexOf(name) !== -1) {\n         // Already output />\n         return;\n      }\n\n      result += \"</\" + name + \">\";\n    }\n  }, options.parser);\n  parser.write(html);\n  parser.end();\n\n  return result;\n\n  function escapeHtml(s) {\n    if (typeof(s) !== 'string') {\n      s = s + '';\n    }\n    return s.replace(/\\&/g, '&amp;').replace(/</g, '&lt;').replace(/\\>/g, '&gt;').replace(/\\\"/g, '&quot;');\n  }\n\n  function naughtyHref(name, href) {\n    // Browsers ignore character codes of 32 (space) and below in a surprising\n    // number of situations. Start reading here:\n    // https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet#Embedded_tab\n    href = href.replace(/[\\x00-\\x20]+/g, '');\n    // Clobber any comments in URLs, which the browser might\n    // interpret inside an XML data island, allowing\n    // a javascript: URL to be snuck through\n    href = href.replace(/<\\!\\-\\-.*?\\-\\-\\>/g, '');\n    // Case insensitive so we don't get faked out by JAVASCRIPT #1\n    var matches = href.match(/^([a-zA-Z]+)\\:/);\n    if (!matches) {\n      // Protocol-relative URL: \"//some.evil.com/nasty\"\n      if (href.match(/^\\/\\//)) {\n        return !options.allowProtocolRelative;\n      }\n\n      // No scheme\n      return false;\n    }\n    var scheme = matches[1].toLowerCase();\n\n    if (has(options.allowedSchemesByTag, name)) {\n      return options.allowedSchemesByTag[name].indexOf(scheme) === -1;\n    }\n\n    return !options.allowedSchemes || options.allowedSchemes.indexOf(scheme) === -1;\n  }\n\n  function filterClasses(classes, allowed) {\n    if (!allowed) {\n      // The class attribute is allowed without filtering on this tag\n      return classes;\n    }\n    classes = classes.split(/\\s+/);\n    return classes.filter(function(clss) {\n      return allowed.indexOf(clss) !== -1;\n    }).join(' ');\n  }\n}\n\n// Defaults are accessible to you so that you can use them as a starting point\n// programmatically if you wish\n\nvar htmlParserDefaults = {\n  decodeEntities: true\n};\nsanitizeHtml.defaults = {\n  allowedTags: [ 'h3', 'h4', 'h5', 'h6', 'blockquote', 'p', 'a', 'ul', 'ol',\n    'nl', 'li', 'b', 'i', 'strong', 'em', 'strike', 'code', 'hr', 'br', 'div',\n    'table', 'thead', 'caption', 'tbody', 'tr', 'th', 'td', 'pre' ],\n  allowedAttributes: {\n    a: [ 'href', 'name', 'target' ],\n    // We don't currently allow img itself by default, but this\n    // would make sense if we did\n    img: [ 'src' ]\n  },\n  // Lots of these won't come up by default because we don't allow them\n  selfClosing: [ 'img', 'br', 'hr', 'area', 'base', 'basefont', 'input', 'link', 'meta' ],\n  // URL schemes we permit\n  allowedSchemes: [ 'http', 'https', 'ftp', 'mailto' ],\n  allowedSchemesByTag: {},\n  allowProtocolRelative: true\n};\n\nsanitizeHtml.simpleTransform = function(newTagName, newAttribs, merge) {\n  merge = (merge === undefined) ? true : merge;\n  newAttribs = newAttribs || {};\n\n  return function(tagName, attribs) {\n    var attrib;\n    if (merge) {\n      for (attrib in newAttribs) {\n        attribs[attrib] = newAttribs[attrib];\n      }\n    } else {\n      attribs = newAttribs;\n    }\n\n    return {\n      tagName: newTagName,\n      attribs: attribs\n    };\n  };\n};\n"]}